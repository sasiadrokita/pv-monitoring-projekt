#!/bin/bash

# ==========================================
# TELEGRAM NOTIFICATION SCRIPT TEMPLATE
# ==========================================
# 1. Rename this file to 'send_url_telegram.sh'
# 2. Move it to your home directory (e.g., /home/pi/)
# 3. Make it executable: chmod +x send_url_telegram.sh
# 4. Fill in your BOT_TOKEN and CHAT_ID below.
# ==========================================

# === CONFIGURATION ===
BOT_TOKEN="YOUR_BOT_TOKEN_HERE"
CHAT_ID="YOUR_CHAT_ID_HERE"
# =====================

# Wait for the tunnel service to start and generate the URL
sleep 10

MAX_RETRIES=12
FOUND=0

for ((i=1; i<=MAX_RETRIES; i++)); do
    # Extract URL from system logs
    URL=$(journalctl -u cloudflared-tunnel.service | grep -o 'https://[a-zA-Z0-9-]\+\.trycloudflare\.com' | tail -n 1)

    if [ -n "$URL" ]; then
        MESSAGE="ðŸš€ *PV-Monitor System Started!*%0A%0AThe system has rebooted successfully.%0A%0AðŸ“Š *New Grafana Access URL:*%0A$URL"
        
        curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
            -d chat_id="$CHAT_ID" \
            -d text="$MESSAGE" \
            -d parse_mode="Markdown" > /dev/null
        
        echo "New URL sent to Telegram."
        FOUND=1
        break
    fi
    
    echo "URL not found yet... attempt $i/$MAX_RETRIES"
    sleep 5
done

if [ $FOUND -eq 0 ]; then
    echo "Failed to find tunnel URL."
fi
